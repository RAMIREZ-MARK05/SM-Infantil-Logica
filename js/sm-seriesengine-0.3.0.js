ÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿï»¿this.sm = this.sm || {};

(function () {
    var seriesEngine = function (htmlCanvasId, cfg, animationEnd, unique) {
        this.initialize(htmlCanvasId, cfg, animationEnd, unique);
    };
    var p = seriesEngine.prototype = new sm.BaseEngine();
    p.singleton = null;
    p.BaseEngine_initialize = p.initialize;

    p.initialize = function (htmlCanvasId, cfg, animationEnd, unique) {
        this.BaseEngine_initialize(htmlCanvasId, cfg, animationEnd, unique);
        this.cfg = cfg;
        this.objetos = [];
        this.objetosEscena = [];
        this.textObjetos = [];
        this.textObjetosEscena = [];
        this.hotAreas = [];
        this.aciertos = 0;
        this.hits = 0;
        this.variables = [];
        this.keyboard = null;
        this.editText = "";
        this.lastValue = "";
        this.textBoxes = [];
    };

    p.BaseEngine_setupObjects = p.setupObjects;
    p.setupObjects = function () {
        if (!this.setup) {
            this.setup = true;
            var dynDomE = document.getElementById("dynDomE");
            dynDomE.innerHTML = "";
            counterDynDomEids = 0;
            this.traceAciertos = 0;
            this.traceIntentos = 0;
            this.stage = this.getStage();

            //this.on("mousedown", this.onPressDown);

            if (this.animationEnd != null && this.animationEnd != undefined) {
                this.animationEnd.width = this.originalWidth;
                this.animationEnd.height = this.originalHeight;
                this.addChild(this.animationEnd);
            }

            //Creacion de elementos acordes al Estilo SM
            this.aciertos = 0;
            this.hits = 0;
            this.editText = "";
            this.lastValue = "";

            // BACKGROUND
            if (this.cfg.backgroundImage) {
                this.bkgImage = new createjs.Bitmap(ImageManager.getImage(this.cfg.backgroundImage.id));
                this.bkgImage.name = this.cfg.backgroundImage.id;
             }
            }

            //Si la actividad no es autocorregible se aÃ±ade botÃ³n de correcciÃ³n
            if (this.cfg.autoEvaluate == false || this.cfg.SeriesEngine.gameType == "reescalar") {
                if (this.educamosBarNav != null) {
                    this.buttonCorrect.engine = this;
                    if (this.cfg.SeriesEngine.gameType != "escribir") {
                        this.buttonCorrect.on("mousedown", function() { this.onEndActivityClic.call(this.educamosBarNav); }, this);
                        this.buttonCorrect.visible = true;
                        this.buttonCorrect.setEnabled(false);
                    }
                } else {
                    this.buttonCorrect = new sm.Button(this.cfg.buttonEnd.width, styles.button.buttonHeight, this.cfg.buttonEnd.x, this.cfg.buttonEnd.y, this.onEndActivityClic);
                    this.buttonCorrect.engine = this;
                    if (this.cfg.buttonEnd.textId == undefined || this.cfg.buttonEnd.textId == null) {
                        this.buttonCorrect.setText("Corregir");
                    } else {
                        this.buttonCorrect.setText(this.cfg.buttonEnd.textId);
                    }
                    this.addChild(this.buttonCorrect);
                }
            }

            //Pastilla (HEADER)
            this.headerTool = new sm.HeaderTool(this.originalWidth);
            this.headerTool.setTituloEnunciado(this.cfg.enunciado);
            this.addChild(this.headerTool);
            //FOOTER
            this.footerTool = new sm.FooterTool(this.originalWidth, 0, this.originalHeight - styles.footerSM.height);
            this.addChild(this.footerTool);

            this.enableObjects();

            this.BaseEngine_setupObjects();

            if (!this.recoveredState) {
                this.recoveredState = true;
                this.getSingelton().loadState();
            } else {
                if (this.buttonSolution != null) {
                    if (this.mode == "A") {
                        if (this.educamosBarNav != null) {
                            this.buttonSolution.visible = false;
                            this.educamosBarNav.reorderVisibleButtons();
                        } else {
//                            this.removeChild(this.buttonSolution);
                        }
                    } else {
                        this.buttonSolution.visible = true;
                    }
                }
            }

////            if (this.educamosBarNav != null && this.buttonCorrect.visible == false) {
////                this.buttonSolution.x = this.buttonCorrect.x;
////            }
        }
    };

    p.generateTextObjects = function (textDefArray) {
        this.textObjetos = [];
        if (textDefArray) {
            for (var o = 0; o < textDefArray.length; o++) {
                var textDef = textDefArray[o];
                //var hot = new sm.HotArea("name", textDef.points, textDef.sizepos, textDef.imagepos, textDef.circle);

                var text = {
                    x: textDef.sizepos.x,
                    y: textDef.sizepos.y,
                    text: textDef.textId,
                    visible: true,

                    font: textDef.font,
                    fontColor: textDef.fontColor
                };

                var hot = new sm.HotTextArea(textDef.sizepos, text);
                hot.enabled = true;
                //hot.setText(text);
                hot.hotAreas = textDef.hotAreas;
                hot.textDef = textDef;

                if (textDef.hotAreas != undefined) {
                    for (var indexHotAreaDef = 0; indexHotAreaDef < textDef.hotAreas.length; indexHotAreaDef++) {
                        var hotAreaDef = textDef.hotAreas[indexHotAreaDef];
                        if (hotAreaDef.dropZones != undefined) {
                            for (var indexDropZoneDef = 0; indexDropZoneDef < hotAreaDef.dropZones.length; indexDropZoneDef++) {
                                var dropZoneDef = hotAreaDef.dropZones[indexDropZoneDef];
                                dropZoneDef.dropped = false;
                            }
                        }
                    }
                }

                hot.stage = this.stage;
                hot.clonable = textDef.clonable;
                hot.onDragDrop = this.onDragDropTextObject;

                if (hot.clonable) {
                    hot.onClone = this.onCloneTextObject;
                }
                hot.onActivate = this.onActivateObject;


                if (textDef.initScale) {
                    hot.initScale = textDef.initScale;
                    hot.scaleX = textDef.initScale;
                    hot.scaleY = textDef.initScale;
                }
                if (textDef.dropScale) {
                    hot.dropScale = textDef.dropScale;
                }

                if (textDef.dragScale) {
                    hot.dragScale = textDef.dragScale;
                }

                this.addChild(hot);
                this.textObjetos.push(hot);
            }
        }
    };

    p.generateObjects = function (objectDefArray) {
        this.objetos = [];
        if (objectDefArray) {
            for (var o = 0; o < objectDefArray.length; o++) {
                var objDef = objectDefArray[o];
                var obj = new sm.ResizeableBitmap(ImageManager.getImage(objDef.id), this.cfg.resizePointSize);
                obj.z = objDef.z ? objDef.z : 0;
                obj.objDef = objDef;
                obj.locked = false;
                obj.hotAreas = objDef.hotAreas;
                if (objDef.hotAreas != undefined) {
                    for (var indexHotAreaDef = 0; indexHotAreaDef < objDef.hotAreas.length; indexHotAreaDef++) {
                        var hotAreaDef = objDef.hotAreas[indexHotAreaDef];
                        if (hotAreaDef.dropZones != undefined) {
                            for (var indexDropZoneDef = 0; indexDropZoneDef < hotAreaDef.dropZones.length; indexDropZoneDef++) {
                                var dropZoneDef = hotAreaDef.dropZones[indexDropZoneDef];
                                dropZoneDef.dropped = false;
                            }
                        }
                    }
                }

                obj.stage = this.stage;
                obj.clonable = false;
                obj.clonable = objDef.clonable;
                obj.editable = objDef.editable && !objDef.clonable;
                obj.canRemove = objDef.editable && objDef.clonable;
                obj.transformInTool = objDef.transformInTool;

                if (objDef.transformInTool == true) {
                    obj.editable = objDef.editable != undefined ? objDef.editable : false;
                    obj.canResize = objDef.canResize != undefined ? objDef.canResize : true;
                    obj.canRotate = objDef.canRotate != undefined ? objDef.canRotate : true;
                    obj.canRemove = objDef.canRemove != undefined ? objDef.canRemove : true;
                    obj.canMove = objDef.canMove != undefined ? objDef.canMove : true;
                    if (obj.canRotate) {

                    }
                }

                if (objDef.editable) {
                    obj.onRemove = this.onRemoveObject;
                }

                if (objDef.rotationIncrement != undefined) {
                    obj.rotationIncrement = objDef.rotationIncrement;
                }

                //obj.excludeObjects = [this.toolZone];
                obj.excludeObjects = [];
                if (objDef.clickable != undefined) {
                    obj.clickable = objDef.clickable;
                    if (obj.clickable) {
                        if (objDef.clickSound) {
                            //                            obj.fx = new buzz.sound(objDef.clickSound, { formats: ["ogg", "mp3"], preload: true, autoload: true, loop: false });
                            //                                    if (SoundManager != undefined && SoundManager != null) SoundManager.play(this.cfg.audioKO);
                            //                            obj.fx.setVolume(100);
                        }
                        obj.onClickObject = this.onClickObject;
                    }
                } else {
                    obj.clickable = false;
                }
                if (objDef.draggable != undefined) {
                    obj.draggable = objDef.draggable;
                } else {
                    obj.draggable = true;
                    obj.onDragDrop = this.onDragDropObject;
                }
                if (objDef.visible != undefined) {
                    obj.visible = objDef.visible;
                } else {
                    obj.visible = true;
                }
                if (objDef.name != undefined) {
                    obj.name = objDef.name;
                } else {
                    obj.name = "objeto_noname";
                }
                obj.onClone = this.onCloneObject;
                obj.onActivate = this.onActivateObject;
                if (objDef.initScale) {
                    obj.initScale = objDef.initScale;
                    obj.scaleX = objDef.initScale;
                    obj.scaleY = objDef.initScale;
                }
                if (objDef.dropScale) {
                    obj.dropScale = objDef.dropScale;
                }

                if (objDef.dragScale) {
                    obj.dragScale = objDef.dragScale;
                }

                obj.x = objDef.x;
                //* - this.weight + obj.regX;
                obj.y = objDef.y;
                //- this.weight + obj.regY;
                this.addChild(obj);
                this.objetos.push(obj);
            }
        }
    };

    p.generateKeyboard = function (keyboardDef) {
        if (keyboardDef) {
            if (keyboardDef.type == "Classic") {
                this.keyboard = new sm.KeyboardClassic(keyboardDef, this.keyboardReturn);
            } else if (keyboardDef.type == "Qwerty" || keyboardDef.type == "QwertyExtended") {
                this.keyboard = new sm.KeyboardQwerty(keyboardDef, this.keyboardReturn);
            } else if (keyboardDef.type == "Numeric") {
                this.keyboard = new sm.KeyboardNumeric(keyboardDef, this.keyboardReturn);
            }
            this.keyboard.x = this.cfg.keyboard.x;
            this.keyboard.y = this.cfg.keyboard.y;
            this.keyboard.name = "keyboard";
            this.addChild(this.keyboard);
            this.keyboard.visible = false;
        }
    };

    p.generateHotAreas = function (hotAreasDefArray) {
        this.targetHits = 0;

        for (var i = 0; i < this.textBoxes.length; i++) {
            this.removeChild(this.textBoxes[i]);

        }
        this.textBoxes = [];

        if (hotAreasDefArray) {
            for (var h = 0 in hotAreasDefArray) {
                var hotDef = hotAreasDefArray[h];
                var hot = new sm.HotArea(hotDef.name, hotDef.points, hotDef.sizepos, hotDef.imagepos, hotDef.circle);
                hot.locked = false;
                hot.name = hotDef.name;
                hot.hotDef = hotDef;
                hot.multidrop = hotDef.multidrop;
                hot.replaceObject = hotDef.replaceObject;
                hot.enabled = hotDef.enabled != undefined ? hotDef.enabled : true;
                hot.hotAreaVisible = hotDef.hotAreaVisible != undefined ? hotDef.hotAreaVisible : false;

                hot.esAreaValida = hotDef.esAreaValida;

                hot.popup = hotDef.popup;
                if (hotDef.hitable) {
                    hot.onClickArea = this.onClickHotArea;
                    this.targetHits++;
                }
                hot.sound = null;
                if (hotDef.sound != undefined) {
                    hot.sound = hotDef.sound;
                }
                var addHot = hotDef.add != undefined ? hotDef.add : true;
                if (addHot) {
                    this.addChild(hot);
                }
                if (hotDef.id) {
                    hot.setTextId(hotDef.id);
                }
                if (hotDef.hotAreaText) {
                    var text = {
                        x: hotDef.hotAreaText.x,
                        y: hotDef.hotAreaText.y,
                        text: hotDef.hotAreaText.text,
                        visible: hotDef.hotAreaText.textVisible,

                        font: hotDef.hotAreaText.font,
                        fontColor: hotDef.hotAreaText.fontColor
                    };

                    hot.enabled = !hotDef.hotAreaText.textVisible;
                    hot.setText(text);

                    if (!hotDef.hotAreaText.textVisible && this.cfg.keyboard == null) {
                        this.htmlTextBoxWidth = hotDef.hotAreaText.width;
                        this.htmlTextBoxHeight = hotDef.hotAreaText.height;
                        var htmlTextBox;
                        if (browserDetect.isIOS) {
                            htmlTextBox = new sm.HtmlTextBox(this.htmlTextBoxWidth, this.htmlTextBoxHeight, "transparent", hotDef.hotAreaText.font, hotDef.hotAreaText.fontColor, "transparent", "left", hotDef.hotAreaText.text.length, false, this.textInputValueChanged);
                        } else {
                            htmlTextBox = new sm.HtmlTextBox(this.htmlTextBoxWidth, this.htmlTextBoxHeight, "transparent", hotDef.hotAreaText.font, hotDef.hotAreaText.fontColor, "transparent", "center", hotDef.hotAreaText.text.length, false, this.textInputValueChanged);                            
                        }
                        htmlTextBox.solutionText = hotDef.hotAreaText.text;
                        htmlTextBox.owner = this;
                        this.textBoxes.push(htmlTextBox);
                        this.addChild(htmlTextBox);
                        htmlTextBox.x = hotDef.hotAreaText.x;
                        htmlTextBox.y = hotDef.hotAreaText.y;
                    }
                }

                if (hotDef.hotAreaImage) {
                    var image = new createjs.Bitmap(ImageManager.getImage(hotDef.hotAreaImage.id));
                    image.name = hotDef.hotAreaImage.id;
                    image.x = hotDef.hotAreaImage.x;
                    image.y = hotDef.hotAreaImage.y;
                    hot.imagepos = image;
                }

                this.hotAreas.push(hot);
            }
        }
    };

    p.processObject = function (obj, mouseX, mouseY) {
        var game = this;
        var valido = false;
        var dropX = null;
        var dropY = null;
        var dropZ = null;
        var hotArea = null;
        var ajustCoordX = true;
        var ajustCoordY = true;
        var dropZoneValida = null;

        if (!this.iniciado) {
            this.com.IniciaEjecucion();
            this.iniciado = true;
        }

        if (obj.hotAreas != undefined) {
            for (var i = 0; i < game.hotAreas.length; i++) {
                hotArea = game.hotAreas[i];
                if (hotArea.enabled) {
                    for (var j = 0; j < obj.hotAreas.length; j++) {
                        if (obj.hotAreas[j].hotArea == hotArea.name && hotArea.pointInHotArea(mouseX, mouseY) && ((game.cfg.autoEvaluate && obj.hotAreas[j].esAreaValida) || game.cfg.autoEvaluate == false)) {
                            if (obj.hotAreas[j].dropZones != undefined) {
                                for (var indexDropZone = 0; indexDropZone < obj.hotAreas[j].dropZones.length; indexDropZone++) {
                                    var dropZone = obj.hotAreas[j].dropZones[indexDropZone];
                                    if (!dropZone.dropped) {
                                        dropX = dropZone.x;
                                        dropY = dropZone.y;
                                        if (dropZone.z != undefined) dropZ = dropZone.z;
                                        dropZone.dropped = true;
                                        dropZoneValida = dropZone;
                                        this.buttonCorrect.setEnabled(true);
                                        break;
                                    }
                                }
                            } else {
                                var objDropX = "same";
                                var objDropY = "same";
                                var objDropZ = 0;
                                if (obj.hotAreas[j].dropCases != undefined) {
                                    var validDropCase = false;
                                    for (var indexDropCase = 0; indexDropCase < obj.hotAreas[j].dropCases.length; indexDropCase++) {
                                        var dropCase = obj.hotAreas[j].dropCases[indexDropCase];
                                        if (dropCase.ang == obj.rotation) {
                                            objDropX = dropCase.x;
                                            objDropY = dropCase.y;
                                            validDropCase = true;
                                            this.buttonCorrect.setEnabled(true);
                                            break;
                                        }
                                    }
                                    if (!validDropCase) {
                                        break;
                                    }
                                } else {
                                    if (obj.hotAreas[j].dropX != undefined) {
                                        objDropX = obj.hotAreas[j].dropX;
                                    }
                                    if (obj.hotAreas[j].dropY != undefined) {
                                        objDropY = obj.hotAreas[j].dropY;
                                    }
                                    if (obj.hotAreas[j].dropZ != undefined) {
                                        objDropZ = obj.hotAreas[j].dropZ;
                                    }
                                }

                                var auxPosObj = { x: 0, y: 0 };
                                if (obj.objDef.inTool) {
                                    //                                auxPosObj.x = obj.x + obj.localToGlobal(mouseX, mouseY).x;
                                    //                                auxPosObj.y = obj.y + obj.localToGlobal(mouseX, mouseY).y;
                                } else {
                                    auxPosObj = obj.globalToLocal(mouseX, mouseY);
                                }
                                if (isNumeric(objDropX)) {
                                    dropX = objDropX;
                                } else {
                                    if (objDropX == "same") {
                                        dropX = mouseX; //mouseX - auxPosObj.x;
                                        ajustCoordX = false;
                                    }
                                }

                                if (isNumeric(objDropY)) {
                                    dropY = objDropY;
                                } else {
                                    if (objDropY == "same") {
                                        dropY = mouseY; //mouseY - auxPosObj.y;
                                        ajustCoordY = false;
                                    }
                                }

                                if (isNumeric(objDropZ)) {
                                    dropZ = objDropZ;
                                }
                            }

                            if (!hotArea.multidrop) {
                                hotArea.enabled = false;
                                hotArea.locked = true;
                            }

                            if (hotArea.replaceObject && hotArea.linkObject) {
                                hotArea.linkObject.scaleX = 1;
                                hotArea.linkObject.scaleY = 1;
                                hotArea.linkObject.x = hotArea.linkObject.origin.x;
                                hotArea.linkObject.y = hotArea.linkObject.origin.y;
                                hotArea.linkObject.enabled = true;
                                this.addChild(hotArea.linkObject);
                            }

                            if (dropX != null && dropY != null && dropX >= 0 && dropY >= 0) {
                                valido = true;
                                i = game.hotAreas.length;
                                if (obj.hotAreas[j].actions != undefined && obj.hotAreas[j].actions != null) {
                                    this.processActions(obj.hotAreas[j].actions);
                                }
                            }
                            break;
                        }
                    }
                }
            }
        } else {
            obj.scaleX = obj.dropScale;
            obj.scaleY = obj.dropScale;
            obj.x = mouseX;
            obj.y = mouseY;
            obj.z = 1;
            this.buttonCorrect.setEnabled(true);
            return true;
        }
        if (valido && hotArea) {
            if (dropX >= 0 && dropY >= 0) {
                obj.scaleX = obj.dropScale;
                obj.scaleY = obj.dropScale;
                if (ajustCoordX) {
                    obj.x = dropX - ((obj.image.width - (obj.image.width * obj.scaleX)) / 2) + obj.regX;
                } else {
                    obj.x = dropX;
                }
                if (ajustCoordY) {
                    obj.y = dropY - ((obj.image.height - (obj.image.height * obj.scaleY)) / 2) + obj.regY;
                } else {
                    obj.y = dropY;
                }
                if (dropZ != null && dropZ >= 0) {
                    obj.z = dropZ;
                }
                hotArea.linkObject = obj;
                this.buttonCorrect.setEnabled(true);

            }
            if (dropZ == null || dropZ <= 0) {
                obj.z = 1;
            }

            if (game.cfg.autoEvaluate == true) {
                obj.enabled = false;
                obj.draggable = false;
                obj.locked = true;
            } else {
                obj.enabled = true;
                obj.draggable = true;
                obj.locked = false;

                if (obj.hotArea != undefined || obj.hotArea != null) {
                    obj.hotArea.linkObject = null;
                    obj.hotArea.enabled = true;
                    obj.hotArea = hotArea;
                    obj.dropZone.dropped = false;
                    obj.dropZone = dropZoneValida;
                } else {
                    obj.hotArea = hotArea;
                    obj.dropZone = dropZoneValida;
                }

            }

            obj.cursor = "default";
            if (obj.editable == true) {
                obj.enabled = true;
            }
            game.reorderLayers();
            if (this.cfg.autoEvaluate) {

                if (this.cfg.questions) {
                    this.hits++;
                    if (!question.totalHits || this.hits >= question.totalHits) {
                        game.aciertos++;
                    }
                } else {
                    game.aciertos++;
                }
                this.notifyPartialSuccess();
            }
        } else {
            obj.x = obj.origin.x;
            obj.y = obj.origin.y;
            if (this.cfg.autoEvaluate) {
//                this.traceIntentos++;
                this.notifyError();
            }
            this.buttonCorrect.setEnabled(true);
        }

        if (valido) {
            game.checkComplete();
        }
        return valido;
    };

    p.processTextObject = function (obj, mouseX, mouseY) {
        var game = this;
        var valido = false;
        var dropX = null;
        var dropY = null;
        var dropZ = null;
        var hotArea = null;
        var ajustCoordX = true;
        var ajustCoordY = true;
        var dropZoneValida = null;

        if (!this.iniciado) {
            this.com.IniciaEjecucion();
            this.iniciado = true;
        }

        if (obj.hotAreas != undefined) {
            for (var i = 0; i < game.hotAreas.length; i++) {
                hotArea = game.hotAreas[i];
                if (hotArea.enabled) {
                    for (var j = 0; j < obj.hotAreas.length; j++) {
                        if (obj.hotAreas[j].hotArea == hotArea.name && hotArea.pointInHotArea(mouseX, mouseY) && ((game.cfg.autoEvaluate && obj.hotAreas[j].esAreaValida) || game.cfg.autoEvaluate == false)) {
                            if (obj.hotAreas[j].dropZones != undefined) {
                                for (var indexDropZone = 0; indexDropZone < obj.hotAreas[j].dropZones.length; indexDropZone++) {
                                    var dropZone = obj.hotAreas[j].dropZones[indexDropZone];
                                    if (!dropZone.dropped) {
                                        dropX = dropZone.x;
                                        dropY = dropZone.y;
                                        if (dropZone.z != undefined) dropZ = dropZone.z;
                                        dropZone.dropped = true;
                                        dropZoneValida = dropZone;
                                        this.buttonCorrect.setEnabled(true);
                                        break;
                                    }
                                }
                            } else {
                                var objDropX = "same";
                                var objDropY = "same";
                                var objDropZ = 0;
                                if (obj.hotAreas[j].dropCases != undefined) {
                                    var validDropCase = false;
                                    for (var indexDropCase = 0; indexDropCase < obj.hotAreas[j].dropCases.length; indexDropCase++) {
                                        var dropCase = obj.hotAreas[j].dropCases[indexDropCase];
                                        if (dropCase.ang == obj.rotation) {
                                            objDropX = dropCase.x;
                                            objDropY = dropCase.y;
                                            validDropCase = true;
                                            this.buttonCorrect.setEnabled(true);
                                            break;
                                        }
                                    }
                                    if (!validDropCase) {
                                        break;
                                    }
                                } else {
                                    if (obj.hotAreas[j].dropX != undefined) {
                                        objDropX = obj.hotAreas[j].dropX;
                                    }
                                    if (obj.hotAreas[j].dropY != undefined) {
                                        objDropY = obj.hotAreas[j].dropY;
                                    }
                                    if (obj.hotAreas[j].dropZ != undefined) {
                                        objDropZ = obj.hotAreas[j].dropZ;
                                    }
                                }

                                var auxPosObj = { x: 0, y: 0 };
                                if (obj.objDef.inTool) {
                                    //                                auxPosObj.x = obj.x + obj.localToGlobal(mouseX, mouseY).x;
                                    //                                auxPosObj.y = obj.y + obj.localToGlobal(mouseX, mouseY).y;
                                } else {
                                    auxPosObj = obj.globalToLocal(mouseX, mouseY);
                                }
                                if (isNumeric(objDropX)) {
                                    dropX = objDropX;
                                } else {
                                    if (objDropX == "same") {
                                        dropX = mouseX; //mouseX - auxPosObj.x;
                                        ajustCoordX = false;
                                    }
                                }

                                if (isNumeric(objDropY)) {
                                    dropY = objDropY;
                                } else {
                                    if (objDropY == "same") {
                                        dropY = mouseY; //mouseY - auxPosObj.y;
                                        ajustCoordY = false;
                                    }
                                }

                                if (isNumeric(objDropZ)) {
                                    dropZ = objDropZ;
                                }
                            }

                            if (!hotArea.multidrop) {
                                hotArea.enabled = false;
                                hotArea.locked = true;
                            }

                            if (dropX != null && dropY != null && dropX >= 0 && dropY >= 0) {
                                valido = true;
                                i = game.hotAreas.length;
                            }
                            break;
                        }
                    }
                }
            }
        } else {
            obj.scaleX = obj.dropScale;
            obj.scaleY = obj.dropScale;
            obj.x = mouseX;
            obj.y = mouseY;
            obj.z = 1;
            this.buttonCorrect.setEnabled(true);
            return true;
        }
        if (valido && hotArea) {
            if (dropX >= 0 && dropY >= 0) {
                obj.scaleX = obj.dropScale;
                obj.scaleY = obj.dropScale;
                if (ajustCoordX) {
                    obj.x = dropX - ((obj.sizepos.width - (obj.sizepos.width * obj.scaleX)) / 2) + obj.regX;
                } else {
                    obj.x = dropX;
                }
                if (ajustCoordY) {
                    obj.y = dropY - ((obj.sizepos.height - (obj.sizepos.height * obj.scaleY)) / 2) + obj.regY;
                } else {
                    obj.y = dropY;
                }
                if (dropZ != null && dropZ >= 0) {
                    obj.z = dropZ;
                }
                hotArea.linkObject = obj;
                this.buttonCorrect.setEnabled(true);

            }
            if (dropZ == null || dropZ <= 0) {
                obj.z = 1;
            }

            if (game.cfg.autoEvaluate == true) {
                obj.enabled = false;
                obj.draggable = false;
                obj.locked = true;
            } else {
                obj.enabled = true;
                obj.draggable = true;
                obj.locked = false;

                if (obj.hotArea != undefined || obj.hotArea != null) {
                    obj.hotArea.linkObject = null;
                    obj.hotArea.enabled = true;
                    obj.hotArea = hotArea;
                    obj.dropZone.dropped = false;
                    obj.dropZone = dropZoneValida;
                } else {
                    obj.hotArea = hotArea;
                    obj.dropZone = dropZoneValida;
                }

            }

            obj.cursor = "default";
            if (obj.editable == true) {
                obj.enabled = true;
            }
            game.reorderLayers();
            if (this.cfg.autoEvaluate) {

                game.aciertos++;
                this.notifyPartialSuccess();
            }
        } else {
            obj.x = obj.origin.x;
            obj.y = obj.origin.y;
            if (this.cfg.autoEvaluate) {
                this.notifyError();
//                game.traceIntentos++;
            }
            this.buttonCorrect.setEnabled(true);
        }

        if (valido) {
            game.checkComplete();
        }
        return valido;
    };

    p.onCorregirClick = function () {
        var engine = seriesEngine.prototype.isPrototypeOf(this.parent) ? this.parent : this;
        if (engine.buttonCorrect.enabled == false)
            return;

        if (engine.keyboard != null) {
//            if (engine.keyboard.visible) {
//                var hotArea = engine.keyboard.owner;
//                engine.buttonCorrect.setEnabled(true);
//                engine.keyboard.visible = false;

//                if (engine.cfg.autoEvaluate == true) {
//                    if (engine.editText == hotArea.solutionText) {
//                        engine.notifyPartialSuccess();
//                        hotArea.enabled = false;
//                        if (engine.checkEndActivity()) {
//                            engine.notifyTotalSuccess();
//                            engine.traceAciertos = 1;
//                            engine.traceTotal = 1; // Segun indicaciones siempre 1.
//                            var data = {
//                                total: engine.traceTotal,
//                                aciertos: engine.traceAciertos,
//                                intentos: engine.traceIntentos
//                            };
//                            engine.getSingelton().registerEnd(engine, data);

//                            var state = engine.getSingelton().getStateData();
//                            engine.getSingelton().saveState(state);
//                            engine.buttonCorrect.setEnabled(false);
//                        }
//                    } else {
//                        engine.notifyError();
//                        hotArea.editText("");
//                    }
//                }

//                hotArea.parent.editText = "";
//            } else 
            //{
                engine.confirmRightResults();
                if (engine.checkEndActivity()) {
                    engine.notifyTotalSuccess();
                    engine.traceAciertos = 1;
                } else {
                    engine.traceAciertos = 0;

                    engine.notifyError();
                    engine.deleteWrongResults();
                    engine.traceIntentos++;
                }
                engine.traceTotal = 1; // Segun indicaciones siempre 1.
                var data = {
                    total: engine.traceTotal,
                    aciertos: engine.traceAciertos,
                    intentos: engine.traceIntentos
                };
                engine.getSingelton().registerEnd(engine, data);

                var state = engine.getSingelton().getStateData();
                engine.getSingelton().saveState(state);
                engine.buttonCorrect.setEnabled(false);
            //}
        } else {
            engine.unFocusTextBoxes();
            var correct = true;
            engine.traceTotal = 1; // Segun indicaciones siempre 1.
            engine.traceIntentos++;
            for (var i = 0; i < engine.textBoxes.length; i++) {
                var textBox = engine.textBoxes[i];
                var value = textBox.getValue();
                if (value.toUpperCase() != textBox.solutionText.toUpperCase()) {
                    correct = false;
                    textBox.setValue("");
                } else {
                    textBox.setEnabled(false);
                }
            }

            if (correct) {
                engine.notifyTotalSuccess();
                engine.traceAciertos = 1;
            } else {
                engine.traceAciertos = 0;
                engine.checkCompleted();
            }

            var data = {
                total: engine.traceTotal,
                aciertos: engine.traceAciertos,
                intentos: engine.traceIntentos
            };
            engine.getSingelton().registerEnd(engine, data);

            var state = engine.getSingelton().getStateData();
            engine.getSingelton().saveState(state);
            engine.buttonCorrect.setEnabled(false);
        }

    };

    p.onEndActivityClic = function (button) {
        var engine = this.parent;
        if (engine != null && engine.buttonCorrect.enabled) {
            engine.traceIntentos++;
            engine.buttonCorrect.setEnabled(false);
            engine.traceTotal = 1; // Segun indicaciones siempre 1.
            switch (engine.cfg.SeriesEngine.gameType) {
                case "escribir":
                    if (engine.keyboard != null) {
                        if (engine.keyboard.visible) {
                            var hotArea = engine.keyboard.owner;
                            engine.traceIntentos--;
                            engine.buttonCorrect.setEnabled(true);
                            engine.keyboard.visible = false;

                            if (engine.cfg.autoEvaluate == true) {
                                if (engine.editText == hotArea.solutionText) {
                                    engine.notifyPartialSuccess();
                                    hotArea.enabled = false;
                                    if (engine.checkEndActivity()) {
                                        engine.notifyTotalSuccess();
                                    }
                                } else {
                                    engine.notifyError();
                                    hotArea.editText("");
                                }
                            }

                            hotArea.parent.editText = "";
                        } else {
                            if (engine.checkEndActivity()) {
                                engine.notifyTotalSuccess();
                                engine.traceAciertos = 1;
                            } else {
                                engine.traceAciertos = 0;
                                engine.notifyError();
                                engine.traceIntentos++;
                            }
                            engine.traceTotal = 1; // Segun indicaciones siempre 1.
                            var data = {
                                total: engine.traceTotal,
                                aciertos: engine.traceAciertos,
                                intentos: engine.traceIntentos
                            };
                            engine.getSingelton().registerEnd(engine, data);

                            var state = engine.getSingelton().getStateData();
                            engine.getSingelton().saveState(state);
                            engine.buttonCorrect.setEnabled(false);
                        }
                    } else {
                        engine.unFocusTextBoxes();
                        var correct = true;
                        for (var i = 0; i < engine.textBoxes.length; i++) {
                            var textBox = engine.textBoxes[i];
                            var value = textBox.getValue();
                            if (value.toUpperCase() != textBox.solutionText.toUpperCase()) {
                                correct = false;
                                textBox.setValue("");
                            } else {
                                textBox.owner.text.visible = true;
                                textBox.visible = false;
                                //textBox.setValue(textBox.solutionText);
                            }
                        }
                        if (correct) {
                            engine.notifyTotalSuccess();
                            engine.traceAciertos = 1;
                        } else {
                            engine.traceAciertos = 0;
                            engine.checkCompleted();
                        }
                    }
                    break;
                case "arrastrar":
                    if (engine.checkHotAreas()) {
                        engine.notifyTotalSuccess();
                        engine.buttonCorrect.setEnabled(false);
                        engine.traceAciertos = 1;

                    } else {
                        engine.notifyError();
                        engine.traceAciertos = 0;
                    }

                    break;
            }

            if (engine.keyboard == null) {
                var data = {
                    total: engine.traceTotal,
                    aciertos: engine.traceAciertos,
                    intentos: engine.traceIntentos
                };

                engine.getSingelton().registerEnd(engine, data);
                var state = this.parent.getSingelton().getStateData();
                this.parent.getSingelton().saveState(state);
            }
        }
    };

    p.checkHotAreas = function () {
        var result = true;

        if (this.objetos.length > 0) {
            for (var i = 0; i < this.objetosEscena.length; i++) {
                var object = this.objetosEscena[i];
                var areaValida = false;

                for (var n = 0; n < object.hotAreas.length; n++) {
                    if (object.hotAreas[n].hotArea == object.hotArea.name) {
                        areaValida = object.hotAreas[n].esAreaValida;
                    }
                }

                if (areaValida == false) {
                    result = false;
                    object.hotArea.linkObject = null;
                    object.hotArea.enabled = true;
                    object.dropZone.dropped = false;

                    if (object.objDef.clonable) {
                        this.removeChild(object);
                    } else {
                        object.x = object.objDef.x;
                        object.y = object.objDef.y;
                        object.scaleX = object.objDef.initScale;
                        object.scaleY = object.objDef.initScale;
                    }

                    this.objetosEscena.splice(i, 1);
                    i--;
                }
            }

            if (this.objetosEscena.length < this.cfg.successes)
                result = false;
        }

        for (var i = 0; i < this.objetos.length; i++) {
            var object = this.objetos[i];
            var areaValida = false;

            if (object.clonable == false && object.hotAreas.length != 0) {
                for (var j = 0; j < object.hotAreas.length; j++) {
                    if (object.hotArea != undefined && object.hotAreas[j].hotArea == object.hotArea.name) {
                        if (!object.hotAreas[j].esAreaValida) {
                            object.hotArea.linkObject = null;
                            object.hotArea.enabled = true;
                            object.dropZone.dropped = false;
                            result = false;
                            object.hotArea = undefined;
                            object.x = object.objDef.x;
                            object.y = object.objDef.y;
                            object.scaleX = object.objDef.initScale;
                            object.scaleY = object.objDef.initScale;
                        }
                        else {
                            result = true;
                        }
                    }
                }
            }
        }

        for (var i = 0; i < this.objetos.length; i++) {
            var object = this.objetos[i];

            if (object.clonable == false && object.hotAreas.length != 0) {
                for (var j = 0; j < object.hotAreas.length; j++) {
                    if (object.hotAreas[j].esAreaValida && object.hotArea == undefined) {
                        result = false;
                    }
                }
            }
        }


        if (this.textObjetos.length > 0) {
            for (var i = 0; i < this.textObjetosEscena.length; i++) {
                var object = this.textObjetosEscena[i];
                var areaValida = false;

                for (var n = 0; n < object.hotAreas.length; n++) {
                    if (object.hotAreas[n].hotArea == object.hotArea.name) {
                        areaValida = object.hotAreas[n].esAreaValida;
                    }
                }

                if (areaValida == false) {
                    result = false;
                    object.hotArea.linkObject = null;
                    object.hotArea.enabled = true;
                    object.dropZone.dropped = false;

                    if (object.textDef.clonable) {
                        this.removeChild(object);
                    } else {
                        object.x = object.sizepos.x;
                        object.y = object.sizepos.y;
                    }

                    this.textObjetosEscena.splice(i, 1);
                    i--;
                }
            }

            if (this.textObjetosEscena.length < this.cfg.successesText)
                result = false;
        }

        for (var i = 0; i < this.textObjetos.length; i++) {
            var object = this.textObjetos[i];

            if (object.clonable == false && object.hotAreas.length != 0) {
                for (var j = 0; j < object.hotAreas.length; j++) {
                    if (object.hotArea != undefined && object.hotAreas[j].hotArea == object.hotArea.name) {
                        if (!object.hotAreas[j].esAreaValida) {
                            object.hotArea.linkObject = null;
                            object.hotArea.enabled = true;
                            object.dropZone.dropped = false;
                            result = false;
                            object.hotArea = undefined;
                            object.x = object.textDef.sizepos.x;
                            object.y = object.textDef.sizepos.y
                        }
                        else {
                            result = true;
                        }
                    }
                }
            }
        }

        for (var i = 0; i < this.textObjetos.length; i++) {
            var object = this.textObjetos[i];

            if (object.clonable == false && object.hotAreas.length != 0) {
                for (var j = 0; j < object.hotAreas.length; j++) {
                    if (object.hotAreas[j].esAreaValida && object.hotArea == undefined) {
                        result = false;
                    }
                }
            }
        }

        return result;
    };

    p.notifyPartialSuccess = function () {
        if (SoundManager != undefined && SoundManager != null) SoundManager.play(this.cfg.audioOK);
    };

    p.checkEndActivity = function () {
        var result = true;

        for (var i = 0; i < this.hotAreas.length; i++) {
            if (this.hotAreas[i].enabled && this.hotAreas[i].hotDef.hitable)
                return false;
        }

        return result;
    };

    p.deleteWrongResults = function () {
        for (var i = 0; i < this.hotAreas.length; i++) {
            if (this.hotAreas[i].enabled && this.hotAreas[i].hotDef.hitable) {
                this.hotAreas[i].editText("");
            }            
        }
    };

    p.confirmRightResults = function () {
        for (var i = 0; i < this.hotAreas.length; i++) {
            if (this.hotAreas[i].solutionText == this.hotAreas[i].dummyText.text && this.hotAreas[i].dummyText.visible == true)
                this.hotAreas[i].enabled = false;
            }
    };

    p.notifyTotalSuccess = function () {
        this.enabled = false;
        this.disableObjects();
        this.buttonCorrect.setEnabled(false);
        if (this.buttonSolution) {
            this.buttonSolution.setEnabled(false);
        }
        this.repeatButton.setEnabled(false);
        if (SoundManager != undefined && SoundManager != null && this.cfg.audioFinal != undefined && this.cfg.audioFinal != null) {
            SoundManager.play(this.cfg.audioFinal, undefined, createjs.proxy(this.onEndActivity, this), undefined);
        } else {
            this.onEndActivity();
        }
    };

    p.BaseEngine_onFinishAnimation = p.onFinishAnimation;
    p.onFinishAnimation = function () {
        if (this.infoVolverAJugar != null) this.infoVolverAJugar.visible = true;
    };

    p.BaseEngine_onRepeatActivity = p.onRepeatActivity;
    p.onRepeatActivity = function () {
        var engine = mainEngine.getActiveEngine();

        if (engine != null && engine.repeatButton.enabled && engine.setup) {
            if (engine.animationEnd != null) {
                engine.animationEnd.stop();
                engine.removeChild(engine.animationEnd);
            }

            engine.setup = false;
            engine.enabled = true;
            engine.destroyObjects();
            engine.destroyAreas();
            if (SoundManager != undefined && SoundManager != null) SoundManager.stop();
            engine.removeChild(engine.getRepeatButton());
            engine.reset();
        }
    };

    p.BaseEngine_stop = p.stop;
    p.stop = function () {
        this.setup = false;
        this.enabled = true;
        this.destroyObjects();
        this.destroyAreas();
        if (SoundManager != undefined && SoundManager != null) SoundManager.stop();
        this.removeChild(this.getRepeatButton());
        this.BaseEngine_stop();
    };

    p.notifyError = function () {
        if (SoundManager != undefined && SoundManager != null) SoundManager.play(this.cfg.audioKO);
    };

    p.validateValue = function (obj) {
        var engine = this.parent;
        if (engine != null && engine.buttonCorrect.enabled) {
            var keyboard = engine.keyboard;
            var hotArea = keyboard.owner;

            keyboard.visible = false;
            if (this.buttonCorrect != undefined) {
                engine.buttonCorrect.setEnabled(false);
            }


            //if (engine.cfg.autoEvaluate == true) {
            if (engine.editText == hotArea.solutionText) {
                engine.notifyPartialSuccess();
                hotArea.enabled = false;
                if (engine.checkEndActivity()) {
                    engine.buttonCorrect.setEnabled(false);
                    //engine.repeatButton.setEnabled(false);
                    engine.notifyTotalSuccess();

                }
            } else {
                engine.notifyError();
                hotArea.editText("");
            }
        }

        engine.editText = "";
        //}
    };

    p.keyboardReturn = function (obj) {
        var code = obj.code;
        var key = obj.text.text;
        var hotArea = obj.parent.owner;

        if (!hotArea.parent.iniciado) {
            hotArea.parent.com.IniciaEjecucion();
            hotArea.parent.iniciado = true;
        }

        if (code == "delete") {
            hotArea.parent.editText = hotArea.parent.editText.substring(0, hotArea.parent.editText.length - 1);
            hotArea.editText(hotArea.parent.editText);
        } else if (code == "ok") {
            obj.parent.visible = false;

            if (hotArea.parent.cfg.autoEvaluate == true) {
                if (hotArea.parent.editText == hotArea.solutionText) {
                    hotArea.parent.notifyPartialSuccess();
                    hotArea.enabled = false;
                    if (hotArea.parent.checkEndActivity()) {
                        hotArea.parent.notifyTotalSuccess();
                    }

                } else {
                    hotArea.parent.notifyError();
                    hotArea.editText("");
                }
            }

            hotArea.parent.editText = "";
        } else if (code == "ko") {
            obj.parent.visible = false;
            hotArea.parent.editText = "";
            hotArea.editText(hotArea.parent.lastValue);
        } else if (code == "space") {
            hotArea.dummyText.color = hotArea.hotDef.hotAreaText.fontColor;
            hotArea.parent.editText = hotArea.parent.editText + " ";
            hotArea.editText(hotArea.parent.editText);
        } else if (code == "intro") {
            hotArea.parent.buttonCorrect.setEnabled(true);
            hotArea.parent.keyboard.visible = false;

            if (hotArea.parent.cfg.autoEvaluate == true) {
                if (hotArea.parent.editText == hotArea.solutionText) {
                    hotArea.parent.notifyPartialSuccess();
                    hotArea.enabled = false;
                    if (hotArea.parent.checkEndActivity()) {
                        hotArea.parent.notifyTotalSuccess();
                        hotArea.parent.traceAciertos = 1;
                        hotArea.parent.traceTotal = 1; // Segun indicaciones siempre 1.
                        var data = {
                            total: hotArea.parent.traceTotal,
                            aciertos: hotArea.parent.traceAciertos,
                            intentos: hotArea.parent.traceIntentos
                        };
                        hotArea.parent.getSingelton().registerEnd(engine, data);

                        var state = hotArea.parent.getSingelton().getStateData();
                        hotArea.parent.getSingelton().saveState(state);
                        hotArea.parent.buttonCorrect.setEnabled(false);
                    }
                } else {
                    hotArea.parent.notifyError();
                    hotArea.editText("");
                }
            }

            hotArea.parent.editText = "";
        } else {
            if (key == "â")
                key = "-";
            if (key == "ââ") {
                key = " ";
            }

            hotArea.dummyText.color = hotArea.hotDef.hotAreaText.fontColor;
            hotArea.parent.editText = hotArea.parent.editText + key;
            hotArea.editText(hotArea.parent.editText);
        }
    };

    p.onClickHotArea = function (obj, x, y) {
        var engine = obj.parent;
        var keyboard = engine.keyboard;

        if (keyboard != null && keyboard.visible == true && obj != keyboard.owner) {
            return;
        }
        if (keyboard != null && keyboard != undefined) {
            if (keyboard.visible == false) {
                keyboard.visible = true;
                if (engine.buttonCorrect != undefined) {
                    engine.buttonCorrect.setEnabled(false);
                }
                keyboard.owner = obj;

                if (obj.dummyText.visible == false) {
                    engine.lastValue = "";
                } else {
                    engine.lastValue = obj.dummyText.text;
                }

            }
        }
    };

    p.onClickObject = function (obj) {
        if (SoundManager != undefined && SoundManager != null && obj.fx) SoundManager.play(obj.fx);

        if (obj.objDef.disableOnClick) {
            obj.enabled = false;
        }
        if (obj.objDef.actions) {
            this.parent.processActions(obj.objDef.actions);
        }
        if (obj.objDef.doHit) {
            obj.parent.hits++;
            if (obj.parent.cfg.questions) {
                var question = obj.parent.cfg.questions[obj.parent.questionIndex];
                if (obj.parent.hits >= question.totalHits) {
                    obj.parent.aciertos++;
                    obj.parent.checkComplete();
                }
            }
        }
    };

    p.onRemoveObject = function (obj) {
        var engine = this.parent;
        var numberObjetos = engine.objetosEscena.length;
        for (var i = 0; i < numberObjetos; i++) {
            if (engine.objetosEscena[i] == obj) {
                engine.objetosEscena.splice(i, 1);
                i--;
                numberObjetos--;
            }
        }
    };

    p.onDragDropObject = function (obj, mouseX, mouseY) {

        if (!this.parent.iniciado) {
            this.parent.com.IniciaEjecucion();
            this.parent.iniciado = true;
        }

        if (!obj.clonable) {
            if (this.parent.processObject(obj, mouseX, mouseY)) {
                if (obj.parent != this.parent) {
                    this.parent.addChild(obj);
                    this.parent.reorderLayers();
                }

                if (obj.editable && obj.parent == this.parent) {
                    obj.activate();
                    obj.desactivate();
                    obj.activate();
                }
            }
        }

        // Para volver a poner por encima el header y el footer
        this.parent.addChild(this.parent.headerTool);
        this.parent.addChild(this.parent.footerTool);
    };

    p.onDragDropTextObject = function (obj, mouseX, mouseY) {
        if (!this.parent.iniciado) {
            this.parent.com.IniciaEjecucion();
            this.parent.iniciado = true;
        }

        if (!obj.clonable) {
            if (this.parent.processTextObject(obj, mouseX, mouseY)) {
                if (obj.parent != this.parent) {
                    this.parent.addChild(obj);
                    this.parent.reorderLayers();
                }
            }
        }

        // Para volver a poner por encima el header y el footer
        this.parent.addChild(this.parent.headerTool);
        this.parent.addChild(this.parent.footerTool);
    };

    p.onActivateObject = function () {
        // Para volver a poner por encima el header y el footer
        this.parent.addChild(this.parent.headerTool);
        this.parent.addChild(this.parent.footerTool);
    };

    p.onCloneObject = function (obj, mouseX, mouseY) {
        obj.stage = this.parent.stage;
        if (obj.objDef.transformInTool == undefined || obj.objDef.transformInTool == false) {
            obj.editable = obj.objDef.editable != undefined ? obj.objDef.editable : false;
            obj.canResize = obj.objDef.canResize != undefined ? obj.objDef.canResize : true;
            obj.canRemove = obj.objDef.canRemove != undefined ? obj.objDef.canRemove : true;
            obj.canRotate = obj.objDef.canRotate != undefined ? obj.objDef.canRotate : true;
            obj.canMove = obj.objDef.canMove != undefined ? obj.objDef.canMove : true;
            obj.onDragDrop = this.parent.onDragDropObject;
            obj.onActivate = this.parent.onActivateObject;
            obj.onRemove = this.parent.onRemoveObject;
        }

        var comparisonValue = obj.image.width > obj.image.height ? obj.image.height : obj.image.width;

        if (mouseX >= 0 && mouseX <= this.parent.originalWidth && mouseY >= styles.headerSM.height && mouseY <= this.parent.originalHeight &&
            (mouseX - obj.origin.x) * (mouseX - obj.origin.x) + (mouseY - obj.origin.y) * (mouseY - obj.origin.y) > comparisonValue * comparisonValue * obj.dropScale * obj.dropScale) {
            this.parent.objetosEscena.push(obj);
            if (this.parent.processObject(obj, mouseX, mouseY)) {
                this.parent.addChild(obj);
                obj.parent.addChild(obj);
                //this.parent.objetosEscena.push(obj);
                this.parent.stage.update();

                if (this.parent.enabled == false) {
                    //this.parent.onEndActivity();
                    if (this.parent.isUnique() && this.parent.animationEnd != null && this.parent.animationEnd != undefined) {
                        this.parent.removeChild(this.parent.animationEnd);
                        this.parent.addChild(this.parent.animationEnd);

                        if (this.parent.cfg.platform == "SM") {
                            this.parent.repeatButton = this.parent.getRepeatButton();
                            this.parent.removeChild(this.parent.repeatButton);
                            this.parent.addChild(this.parent.repeatButton);
                        }
                    }
                }
            } else {
                this.parent.objetosEscena.splice(this.parent.objetosEscena.length - 1, 1);
            }
        }
        if (obj.editable && obj.parent == this.parent) {
            obj.activate();
            obj.desactivate();
            obj.activate();
        }
        this.parent.reorderLayers();
    };

    p.onCloneTextObject = function (obj, mouseX, mouseY) {
        obj.stage = this.parent.stage;

        obj.onDragDrop = this.parent.onDragDropTextObject;
        obj.onActivate = this.parent.onActivateObject;

        var comparisonValue = obj.sizepos.width > obj.sizepos.height ? obj.sizepos.height : obj.sizepos.width;

        if (mouseX >= 0 && mouseX <= this.parent.originalWidth && mouseY >= styles.headerSM.height && mouseY <= this.parent.originalHeight &&
            (mouseX - obj.origin.x) * (mouseX - obj.origin.x) + (mouseY - obj.origin.y) * (mouseY - obj.origin.y) > comparisonValue * comparisonValue * obj.dropScale * obj.dropScale) {
            this.parent.textObjetosEscena.push(obj);
            if (this.parent.processTextObject(obj, mouseX, mouseY)) {
                this.parent.addChild(obj);
                obj.parent.addChild(obj);
                this.parent.stage.update();

                if (this.parent.enabled == false) {
                    //this.parent.onEndActivity();
                    if (this.parent.isUnique() && this.parent.animationEnd != null && this.parent.animationEnd != undefined) {
                        this.parent.removeChild(this.parent.animationEnd);
                        this.parent.addChild(this.parent.animationEnd);

                        if (this.parent.cfg.platform == "SM") {
                            this.parent.repeatButton = this.parent.getRepeatButton();
                            this.parent.removeChild(this.parent.repeatButton);
                            this.parent.addChild(this.parent.repeatButton);
                        }
                    }
                }
            } else {
                this.parent.textObjetosEscena.splice(this.parent.textObjetosEscena.length - 1, 1);
            }
        }
        this.parent.reorderLayers();
    };

    p.reorderLayers = function () {
        if (this.enabled) {
            this.children.sort(function (a, b) {
                if (!a.z) a.z = 0;
                if (!b.z) b.z = 0;
                return a.z - b.z;
            });
            // Para volver a poner por encima el header y el footer
            this.addChild(this.headerTool);
            this.addChild(this.footerTool);
        }
    };

    p.enableObjects = function () {
        var i;
        for (i = 0; i < this.objetosEscena.length; i++) {
            if (this.objetosEscena[i].locked == undefined || this.objetosEscena[i].locked == false) {
                this.objetosEscena[i].enabled = true;
            }
        }

        for (i = 0; i < this.objetos.length; i++) {
            if (this.objetos[i].locked == undefined || this.objetos[i].locked == false) {
                this.objetos[i].enabled = true;
            }
        }
        for (i = 0; i < this.hotAreas.length; i++) {
            if (this.hotAreas[i].locked == undefined || this.hotAreas[i].locked == false) {
                this.hotAreas[i].enabled = true;
            }
        }
        for (i = 0; i < this.textObjetosEscena.length; i++) {
            this.textObjetosEscena[i].enabled = true;
        }

        for (i = 0; i < this.textObjetos.length; i++) {
            this.textObjetos[i].enabled = true;
        }
    };

    p.disableObjects = function () {
        var i;
        for (i = 0; i < this.objetosEscena.length; i++) {
            this.objetosEscena[i].enabled = false;
        }
        for (i = 0; i < this.textObjetosEscena.length; i++) {
            this.textObjetosEscena[i].enabled = false;
        }

        for (i = 0; i < this.textObjetos.length; i++) {
            this.textObjetos[i].enabled = false;
        }

        for (i = 0; i < this.objetos.length; i++) {
            this.objetos[i].enabled = false;
            try {
                this.objetos[i].desactivate();
            } catch (err) {
            }
        }
        for (i = 0; i < this.hotAreas.length; i++) {
            this.hotAreas[i].enabled = false;
        }
    };

    p.desactiveObjects = function () {
        for (var i = 0; i < this.objetosEscena.length; i++) {
            if (this.objetosEscena[i].desactivate != undefined)
                this.objetosEscena[i].desactivate();
        }
        for (i = 0; i < this.objetos.length; i++) {
            if (this.objetos[i].desactivate != undefined)
                this.objetos[i].desactivate();
        }
    };

    p.destroyAreas = function () {
        for (var i = 0; i < this.hotAreas.length; i++) {
            this.removeChild(this.hotAreas[i]);
        }
        this.hotAreas = [];
    };

    p.destroyObjects = function () {
        var i;
        for (i = 0; i < this.objetosEscena.length; i++) {
            if (this.objetosEscena[i].desactivate != undefined)
                this.objetosEscena[i].desactivate();

            this.removeChild(this.objetosEscena[i]);
        }
        this.objetosEscena = [];
        for (i = 0; i < this.objetos.length; i++) {
            if (this.objetos[i].editable) {
                this.objetos[i].desactivate();
            }
            this.removeChild(this.objetos[i]);
        }
        for (i = 0; i < this.textObjetosEscena.length; i++) {
            this.removeChild(this.textObjetosEscena[i]);
        }
        this.textObjetosEscena = [];

        for (i = 0; i < this.textObjetos.length; i++) {
            this.removeChild(this.textObjetos[i]);
        }
        this.textObjetos = [];

        if (this.forzeDestroy) {
            var objectsToRemove = [];
            for (i = 0; i < this.children.length; i++) {
                if (this.children[i] instanceof createjs.ResizeableBitmap) {
                    objectsToRemove.push(this.children[i]);
                }
                if (this.children[i] instanceof HotTextArea) {
                    objectsToRemove.push(this.children[i]);
                }
            }
            for (i = 0; i < objectsToRemove.length; i++) {
                this.removeChild(objectsToRemove[i]);
            }
        }
        this.objetos = [];
        this.variables = [];

        for (i = 0; i < this.textBoxes.length; i++) {
            this.removeChild(this.textBoxes[i]);
        }

        this.textBoxes = [];
    };

    p.checkComplete = function () {
        var successes = this.cfg.successes != undefined ? this.cfg.successes : this.objetos.length;
        var succesesText = this.cfg.successesText != undefined ? this.cfg.successesText : this.textObjetos.length;

        var total = successes + succesesText;

        if (total > 0 && this.aciertos == total) {
            this.aciertos = 0;
            this.disableObjects();
            this.notifyTotalSuccess();

            this.traceTotal = 1;
            this.traceIntentos = 1;
            this.traceAciertos = 1;
            var data = {
                total: this.traceTotal,
                aciertos: this.traceAciertos,
                intentos: this.traceIntentos
            };

            this.getSingelton().registerEnd(this, data);
            var state = this.getSingelton().getStateData();
            this.getSingelton().saveState(state);
        }
    };

    p.BaseEngine_onEndActivity = p.onEndActivity;
    p.onEndActivity = function () {
        if (this.activityEnded) {
            return;
        }
        this.activityEnded = true;
        this.repeatButton.setEnabled(true);
        if (this.isUnique() && this.animationEnd != null && this.animationEnd != undefined) {
            this.removeChild(this.animationEnd);
            this.addChild(this.animationEnd);
            this.animationEnd.run(this.onFinishAnimation);
            if (this.cfg.platform == "SM") {
                this.repeatButton = this.getRepeatButton();
                this.removeChild(this.repeatButton);
                this.addChild(this.repeatButton);
            } else {
                this.repeatButton = this.educamosBarNav.getButton("Repeat");
                this.repeatButton.setEnabled(true);
            }

            if (this.infoVolverAJugar != null) this.infoVolverAJugar.visible = true;
        } else if (this.isUnique() == false) {
            this.getSingelton().onEndActivity();
        } else {
            if (this.cfg.platform == "SM") {
                this.repeatButton = this.getRepeatButton();
                this.removeChild(this.repeatButton);
                this.addChild(this.repeatButton);
            } else {
                this.repeatButton = this.educamosBarNav.getButton("Repeat");
                this.repeatButton.setEnabled(true);
            }
        }
    };

    p.unFocusTextBoxes = function () {
        for (var i = 0; i < this.textBoxes.length; i++) {
            this.textBoxes[i].htmlElement.blur();
        }
        document.getElementById("dummylink").focus();
    };

    function isNumeric(sText) {
        var validChars = "0123456789.";
        var isNumber = true;
        var caracter;

        for (var indexChar = 0; indexChar < sText.length && isNumber == true; indexChar++) {
            caracter = sText.charAt(indexChar);
            if (validChars.indexOf(caracter) == -1) {
                isNumber = false;
            }
        }
        return isNumber;
    }

    p.enableTextBoxes = function () {
        for (var i = 0; i < this.textBoxes.length; i++) {
            this.textBoxes[i].setEnabled(true);
        }
    };

    p.disableTextBoxes = function () {
        for (var i = 0; i < this.textBoxes.length; i++) {
            this.textBoxes[i].setEnabled(false);
        }
    };

    p.textInputValueChanged = function () {
        var engine = this.parent;
        if (!engine.iniciado) {
            engine.com.IniciaEjecucion();
            engine.iniciado = true;
        }

        if (engine.cfg.autoEvaluate == false) {
            engine.checkCompleted();
        } else {
            engine.checkTextData();
        }

        engine.unFocusTextBoxes();
    };

    p.checkTextData = function () {
        var correct = true;
        this.traceTotal = 1; // Segun indicaciones siempre 1.

        if (this.textBoxes.length == 0)
            return;

        if (this.cfg.autoEvaluate) {
            for (var i = 0; i < this.textBoxes.length; i++) {
                var textBox = this.textBoxes[i];
                var value = textBox.getValue();
                if (value.toUpperCase() != textBox.solutionText.toUpperCase()) {
                    correct = false;
                    if (value != "") {
//                        this.traceIntentos++;
                    }
                    textBox.setValue("");
                } else {
                    textBox.setEnabled(false);
                }
            }

            if (correct) {
                this.notifyTotalSuccess();
                this.traceTotal = 1;
                this.traceIntentos = 1;
                this.traceAciertos = 1;
                this.buttonCorrect.setEnabled(false);
                var data = {
                    total: this.traceTotal,
                    aciertos: this.traceAciertos,
                    intentos: this.traceIntentos
                };
                this.getSingelton().registerEnd(this, data);
                var state = this.getSingelton().getStateData();
                this.getSingelton().saveState(state);
            } else {
                this.traceAciertos = 0;
            }
        }
    };

    p.onPressDown = function (e) {
        var engine = e.currentTarget;
        var correct = true;
        engine.traceTotal = 1; // Segun indicaciones siempre 1.

        if (engine.textBoxes.length == 0)
            return;

        if (engine.cfg.autoEvaluate && engine.traceAciertos == 0) {
            for (var i = 0; i < engine.textBoxes.length; i++) {
                var textBox = engine.textBoxes[i];
                var value = textBox.getValue();
                if (value.toUpperCase() != textBox.solutionText.toUpperCase()) {
                    correct = false;
                    if (value != "") {
//                        engine.traceIntentos++;
                    }
                    textBox.setValue("");
                } else {
                    textBox.setEnabled(false);
                }
            }

            if (correct) {
                engine.notifyTotalSuccess();
                engine.traceAciertos = 1;
                engine.buttonCorrect.setEnabled(false);
                var data = {
                    total: engine.traceTotal,
                    aciertos: engine.traceAciertos,
                    intentos: engine.traceIntentos
                };
                engine.getSingelton().registerEnd(engine, data);
                var state = this.getSingelton().getStateData();
                this.getSingelton().saveState(state);
            } else {
                engine.traceAciertos = 0;
            }
        }
        engine.unFocusTextBoxes();
    };

    //Todos completos para activar el botÃ³n de corregir
    //    p.checkCompleted = function () {
    //        var completed = true;
    //        for (var i = 0; i < this.textBoxes.length; i++) {
    //            var textBox = this.textBoxes[i];
    //            var value = textBox.getValue();
    //            if (value == "") {
    //                completed = false;
    //                break;
    //            }
    //        }
    //        this.buttonCorrect.setEnabled(completed);
    //    };

    // Al menos uno completo para activar el botÃ³n de corregir
    p.checkCompleted = function () {
        var completed = false;
        for (var i = 0; i < this.textBoxes.length; i++) {
            var textBox = this.textBoxes[i];
            var value = textBox.getValue();
            if (value != "") {
                completed = true;
                break;
            }
        }
        this.buttonCorrect.setEnabled(completed);
        if (this.buttonSolution) {
            this.buttonSolution.setEnabled(completed);
        }
    };

    p.forceEnd = function () {
        this.notifyTotalSuccess();
        this.buttonCorrect.setEnabled(false);
        if (this.buttonSolution) {
            this.buttonSolution.setEnabled(false);
        }
    };

    p.BaseEngine_loadState = p.loadState;
    p.loadState = function () {
        (function (engine) {
            engine.com.RecuperaConfiguracion({
                onSuccess: function (data) {
                    /*
                     * El parÃ¡metro 'data' contiene un Json con los siguienetes datos:
                     *     - modo[P|A]:     Modo en el que se estÃ¡ ejecutando el contenido
                     *              P:  Modo Profesor
                     *              A:  Alumno
                     *     - estado:        Ãºltimo estado guardado de la actividad
                     */
                    engine.mode = data.mode;
                    engine.setMode(data.mode);
                    if (data.estado != null) {
                        var state = data.estado;
                        engine.getSingelton().setStateData(state, engine.mode);
                    }
                    console.log('Configuracion recuperada correctamente');
                },
                onError: function (error) {
                    // Esta funciÃ³n se ejecutarÃ¡ en caso de que ocurra un error durante el proceso
                    // En caso de error la actividad debe cargarse en un estado inicial y en modo alumno(A)
                    console.log('OcurriÃ³ un error al recuperar el estado' + JSON.stringify(error));
                },
                onComplete: function () {
                    // Esta funciÃ³n se ejecutarÃ¡ al finalizar el proceso tanto si este
                    // ha finalizado correctamente como si ha ocurrido algÃºn error
                    console.log('Proceso de recuperaciÃ³n de estado finalizado');
                }
            });
        })(this);
    };

    p.BaseEngine_setStateData = p.setStateData;
    p.setStateData = function (state, mode) {
        if (state.engine != "series" || state.gameType != this.cfg.SeriesEngine.gameType) {
            return;
        }
        var i = 0;

        switch (this.cfg.SeriesEngine.gameType) {
            case "arrastrar":
                if (state.images != undefined && state.images.length == this.objetos.length) {
                    for (i = 0; i < this.objetos.length; i++) {
                        if (state.images[i] != undefined) {
                            for (var j = 0; j < state.images[i].length; j++) {
                                if (this.objetos[i].clonable) {
                                    var objCloned = this.objetos[i].clone();
                                    if (this.objetos[i].objDef != undefined) {
                                        objCloned.objDef = this.objetos[i].objDef;
                                        objCloned.scaleX = this.objetos[i].objDef.dropScale;
                                        objCloned.scaleY = this.objetos[i].objDef.dropScale;
                                    }

                                    this.objetos[i].onClone(objCloned, state.images[i][j].x, state.images[i][j].y);
                                } else {
                                    this.objetos[i].onDragDrop(this.objetos[i], state.images[i][j].x, state.images[i][j].y);

                                    if (this.objetos[i].objDef.x == state.images[i][j].x && this.objetos[i].objDef.y == state.images[i][j].y) {
                                        this.objetos[i].scaleX = this.objetos[i].objDef.initScale;
                                        this.objetos[i].scaleY = this.objetos[i].objDef.initScale;
                                    } else {
                                        this.objetos[i].scaleX = this.objetos[i].objDef.dropScale;
                                        this.objetos[i].scaleY = this.objetos[i].objDef.dropScale;
                                    }
                                }
                            }
                        }
                    }
                }
                if (state.texts != undefined && state.texts.length == this.textObjetos.length) {
                    for (i = 0; i < this.textObjetos.length; i++) {
                        if (state.texts[i] != undefined) {
                            for (var j = 0; j < state.texts[i].length; j++) {
                                if (this.textObjetos[i].clonable) {
                                    var objCloned = this.textObjetos[i].clone();
                                    if (this.textObjetos[i].textDef != undefined) {
                                        objCloned.textDef = this.textObjetos[i].textDef;
                                    }
                                    this.textObjetos[i].onClone(objCloned, state.texts[i][j].x, state.texts[i][j].y);
                                } else {
                                    if (this.textObjetos[i].textDef.sizepos.x != state.texts[i][j].x && this.textObjetos[i].textDef.sizepos.y != state.texts[i][j].y) {
                                        this.textObjetos[i].onDragDrop(this.textObjetos[i], state.texts[i][j].x + this.textObjetos[i].textDef.sizepos.width / 2, state.texts[i][j].y + this.textObjetos[i].textDef.sizepos.height / 2);
                                    }
                                }
                            }
                        }
                    }
                }
                break;
            case "escribir":
                if (state.texts != undefined && state.texts.length == this.textBoxes.length) {
                    for (i = 0; i < state.texts.length; i++) {
                        var value = state.texts[i];
                        if (value != undefined && value != null && value != "") {
                            this.textBoxes[i].setValue(value);
                            this.textBoxes[i].setEnabled(false);
                        }
                    }
                }
                if (state.texts != undefined && state.texts.length == this.hotAreas.length && this.keyboard) {
                    for (i = 0; i < state.texts.length; i++) {
                        var value = state.texts[i];
                        if (value != undefined && value != null && value != "") {
                            this.hotAreas[i].dummyText.text = value;
                            this.hotAreas[i].dummyText.visible = true;
                            this.hotAreas[i].enabled = this.hotAreas[i].hotDef.hotAreaText.textVisible;
                            this.confirmRightResults();
                        }
                    }
                }
                break;
            case "reescalar":
                if (state.images != undefined && state.images.length == this.objetos.length) {
                    for (i = 0; i < this.objetos.length; i++) {
                        if (state.images[i] != undefined) {
                            for (var j = 0; j < state.images[i].length; j++) {
                                if (this.objetos[i].clonable) {
                                    var objCloned = this.objetos[i].clone();
                                    if (this.objetos[i].objDef != undefined) {
                                        objCloned.objDef = this.objetos[i].objDef;
                                        objCloned.scaleX = this.objetos[i].objDef.dropScale;
                                        objCloned.scaleY = this.objetos[i].objDef.dropScale;
                                    }

                                    objCloned.sourceRect.width = state.images[i][j].width;
                                    objCloned.sourceRect.height = state.images[i][j].height;
                                    objCloned.regX = state.images[i][j].width / 2;
                                    objCloned.regY = state.images[i][j].height / 2;
                                    objCloned.rotation = state.images[i][j].rotation;

                                    this.objetos[i].onClone(objCloned, state.images[i][j].x, state.images[i][j].y);
                                    objCloned.setPositionHandles();

                                } else {
                                    this.objetos[i].onDragDrop(this.objetos[i], state.images[i][j].x, state.images[i][j].y);

                                    this.objetos[i].sourceRect.width = state.images[i][j].width;
                                    this.objetos[i].sourceRect.height = state.images[i][j].height;
                                    //this.objetos[i].orgRect.width = state.images[i][j].width;
                                    //this.objetos[i].orgRect.height = state.images[i][j].height;
                                    this.objetos[i].regX = state.images[i][j].width / 2;
                                    this.objetos[i].regY = state.images[i][j].height / 2;
                                    this.objetos[i].rotation = state.images[i][j].rotation;
                                    if (this.objetos[i].objDef.x == state.images[i][j].x && this.objetos[i].objDef.y == state.images[i][j].y) {
                                        this.objetos[i].scaleX = this.objetos[i].objDef.initScale;
                                        this.objetos[i].scaleY = this.objetos[i].objDef.initScale;
                                    } else {
                                        this.objetos[i].scaleX = this.objetos[i].objDef.dropScale;
                                        this.objetos[i].scaleY = this.objetos[i].objDef.dropScale;
                                    }

                                    this.objetos[i].setPositionHandles();
                                }
                            }
                        }
                    }
                }
                break;
        }

        this.traceTotal = state.total;
        this.traceAciertos = state.aciertos;
        this.traceIntentos = state.intentos;

        this.buttonCorrect.setEnabled(false);

        if (this.traceAciertos != 0) {
            this.forceEnd();
            this.disableObjects();
        }
    };

    p.BaseEngine_getStateData = p.getStateData;
    p.getStateData = function () {
        var state = {};
        var points = [];
        switch (this.cfg.SeriesEngine.gameType) {
            case "arrastrar":
                state = {};
                var images = [];
                for (var i = 0; i < this.objetos.length; i++) {
                    points = [];
                    if (this.objetos[i].clonable) {
                        for (var j = 0; j < this.objetosEscena.length; j++) {
                            if (this.objetos[i].objDef.id == this.objetosEscena[j].objDef.id) {
                                var point = {};
                                point.x = this.objetosEscena[j].x;
                                point.y = this.objetosEscena[j].y;
                                points.push(point);
                            }
                        }
                    } else {
                        var point = {};
                        point.x = this.objetos[i].x;
                        point.y = this.objetos[i].y;
                        points.push(point);
                    }

                    images.push(points);
                }

                state.images = images;
                var texts = [];
                for (var i = 0; i < this.textObjetos.length; i++) {
                    points = [];
                    if (this.textObjetos[i].clonable) {
                        for (var j = 0; j < this.textObjetosEscena.length; j++) {
                            if (this.textObjetos[i].text.text == this.textObjetosEscena[j].text.text) {
                                var point = {};
                                point.x = this.textObjetosEscena[j].x;
                                point.y = this.textObjetosEscena[j].y;
                                points.push(point);
                            }
                        }
                    } else {
                        var point = {};
                        point.x = this.textObjetos[i].x;
                        point.y = this.textObjetos[i].y;
                        points.push(point);
                    }

                    texts.push(points);
                }

                state.texts = texts;
                break;
            case "escribir":
                state = { texts: [] };
                if (this.textBoxes.length > 0) {
                    for (var i = 0; i < this.textBoxes.length; i++) {
                        var value = this.textBoxes[i].getValue();
                        state.texts.push(value);
                    }
                } else {
                    for (var i = 0; i < this.hotAreas.length; i++) {
                        var value = "";
                        if (this.hotAreas[i].dummyText.visible == true){
                            value = this.hotAreas[i].dummyText.text;
                        }
                        state.texts.push(value);
                    }
                }


                break;
            case "reescalar":
                state = { images: [] };
                for (var i = 0; i < this.objetos.length; i++) {
                    points = [];
                    if (this.objetos[i].clonable) {
                        for (var j = 0; j < this.objetosEscena.length; j++) {
                            if (this.objetos[i].objDef.id == this.objetosEscena[j].objDef.id) {
                                var point = {};
                                point.x = this.objetosEscena[j].x;
                                point.y = this.objetosEscena[j].y;
                                point.width = this.objetosEscena[j].sourceRect.width;
                                point.height = this.objetosEscena[j].sourceRect.height;
                                point.rotation = this.objetosEscena[j].rotation;
                                points.push(point);
                            }
                        }
                    } else {
                        var point = {};
                        point.x = this.objetos[i].x;
                        point.y = this.objetos[i].y;
                        point.width = this.objetos[i].sourceRect.width;
                        point.height = this.objetos[i].sourceRect.height;
                        point.rotation = this.objetos[i].rotation;
                        points.push(point);
                    }
                    state.images.push(points);
                }
                break;
        }

        state.total = this.traceTotal;
        state.aciertos = this.traceAciertos;
        state.intentos = this.traceIntentos;

        state.engine = "series";
        state.gameType = this.cfg.SeriesEngine.gameType;
        return state;
    };

    p.BaseEngine_saveState = p.saveState;
    p.saveState = function (state) {
        this.com.AlmacenaEstado({
            estado: state,
            onSuccess: function () {
                // Esta funciÃ³n se ejecutarÃ¡ al finalizar el proceso de guardado
                console.log('Estado almacenado correctamente');
            },
            onError: function (error) {
                // Esta funciÃ³n se ejecutarÃ¡ en caso de que ocurra un error durante el proceso
                console.log('OcurriÃ³ un error al almacenar el estado' + JSON.stringify(error));
            },
            onComplete: function () {
                // Esta funciÃ³n se ejecutarÃ¡ al finalizar el proceso de guardado tanto si este
                // ha finalizado correctamente como si ha ocurrido algÃºn error
                console.log('Proceso de guardado finalizado');
            }
        });
    };
    
        p.BaseEngine_setMode = p.setMode;
    p.setMode = function (mode) {
        this.mode = mode;
        if (this.buttonSolution != null) {
            if (mode == "A") {
                if (this.educamosBarNav != null) {
                    this.buttonSolution.visible = false;
                    this.educamosBarNav.reorderVisibleButtons();
                } else {
//                    this.removeChild(this.buttonSolution);
                }
            }
            else {
                this.buttonSolution.visible = true;
            }
        }
    };

    p.onSolutionClick = function() {
        var engine = this.parent;

        // Si no se ha iniciado lo iniciamos
        if (!engine.iniciado) {
            engine.com.IniciaEjecucion();
            engine.iniciado = true;
        }

        switch (engine.cfg.SeriesEngine.gameType) {
        case "arrastrar":
            if (engine.cfg.imageObjects != null && engine.cfg.imageObjects.length != 0) {
                engine.generateImageSolution(engine.cfg.imageObjects);
            }

            if (engine.cfg.textObjects && engine.cfg.textObjects.length != 0) {
                engine.generateTextSolution(engine.cfg.textObjects);
            }
            break;
        case "escribir":
            if (engine.cfg.hotAreas) {
                engine.generateTextEditSolution(engine.cfg.hotAreas);
            }
            break;
        }

        engine.enabled = false;
        engine.buttonSolution.setEnabled(false);
        engine.disableObjects();
        if (engine.buttonCorrect != undefined) {
            engine.buttonCorrect.setEnabled(false);
        }

        engine.com.VerSolucion();
    };

    p.generateImageSolution = function(objectDefArray) {
        if (objectDefArray) {
            this.destroyObjects();
            for (var o = 0; o < objectDefArray.length; o++) {
                var objDef = objectDefArray[o];

                if (objDef.hotAreas != undefined) {
                    for (var indexHotAreaDef = 0; indexHotAreaDef < objDef.hotAreas.length; indexHotAreaDef++) {
                        var hotAreaDef = objDef.hotAreas[indexHotAreaDef];
                        if (hotAreaDef.dropZones != undefined) {
                            for (var indexDropZoneDef = 0; indexDropZoneDef < hotAreaDef.dropZones.length; indexDropZoneDef++) {
                                var dropZoneDef = hotAreaDef.dropZones[indexDropZoneDef];
                                if (hotAreaDef.esAreaValida) {
                                    var obj = new sm.ResizeableBitmap(ImageManager.getImage(objDef.id), this.cfg.resizePointSize);

                                    obj.scaleX = objDef.dropScale;
                                    obj.scaleY = objDef.dropScale;
                                    
                                    obj.x = dropZoneDef.x - ((obj.image.width - (obj.image.width * obj.scaleX)) / 2) + obj.regX;
                                    obj.y = dropZoneDef.y - ((obj.image.height - (obj.image.height * obj.scaleY)) / 2) + obj.regY;

                                    this.addChild(obj);
                                    this.objetosEscena.push(obj);
                                }
                            }
                        }
                    }
                }
            }
        }
    };

    p.generateTextSolution = function(textDefArray) {
        if (textDefArray) {
            this.destroyObjects();
            this.disableTextBoxes();
            for (var o = 0; o < textDefArray.length; o++) {
                var textDef = textDefArray[o];

                if (textDef.hotAreas != undefined) {
                    for (var indexHotAreaDef = 0; indexHotAreaDef < textDef.hotAreas.length; indexHotAreaDef++) {
                        var hotAreaDef = textDef.hotAreas[indexHotAreaDef];
                        if (hotAreaDef.dropZones != undefined) {
                            for (var indexDropZoneDef = 0; indexDropZoneDef < hotAreaDef.dropZones.length; indexDropZoneDef++) {
                                var dropZoneDef = hotAreaDef.dropZones[indexDropZoneDef];
                                if (hotAreaDef.esAreaValida) {
                                    var text = {
                                        x: textDef.sizepos.x,
                                        y: textDef.sizepos.y,
                                        text: textDef.textId,
                                        visible: true,

                                        font: textDef.font,
                                        fontColor: textDef.fontColor
                                    };

                                    var hot = new sm.HotTextArea(textDef.sizepos, text);

                                    hot.scaleX = textDef.dropScale;
                                    hot.scaleY = textDef.dropScale;

                                    hot.x = dropZoneDef.x - ((textDef.sizepos.width - (textDef.sizepos.width * hot.scaleX)) / 2) + hot.regX;

                                    hot.y = dropZoneDef.y - ((textDef.sizepos.width - (textDef.sizepos.width * hot.scaleX)) / 2) + hot.regX;


                                    this.addChild(hot);
                                    this.textObjetosEscena.push(hot);
                                }
                            }
                        }
                    }
                }
            }
        }
    };

    p.generateTextEditSolution = function(hotAreasDefArray) {
        for (var i = 0; i < this.hotAreas.length; i++) {
            var ha = this.hotAreas[i];
            var hotDef = ha.hotDef;

            if (hotDef.hotAreaText.textVisible == false && hotDef.hotAreaText) {
                var text = {
                    x: hotDef.hotAreaText.x,
                    y: hotDef.hotAreaText.y,
                    text: hotDef.hotAreaText.text,
                    visible: true,

                    font: hotDef.hotAreaText.font,
                    fontColor: hotDef.hotAreaText.fontColor
                };

                ha.enabled = false;
                ha.setText(text);
            }
        }


        for (var i = 0; i < this.textBoxes.length; i++) {
            this.removeChild(this.textBoxes[i]);

        }
        this.textBoxes = [];
        var dynDomE = document.getElementById("dynDomE");
        dynDomE.innerHTML = "";
    };
    ////////////////////////////////////

    sm.SeriesEngine = seriesEngine;
}(window));
